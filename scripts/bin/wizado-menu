#!/usr/bin/env bash
# Wizado TUI menu

# Get license status
status=$(wizado status 2>/dev/null | jq -r '.alt // "unknown"')
if [[ "$status" == "licensed" ]]; then
    status_text="Licensed"
    status_color="82"
else
    status_text="Unlicensed"
    status_color="196"
fi

echo ""
gum style \
    --foreground 212 \
    --border-foreground 212 \
    --border double \
    --align center \
    --width 40 \
    --margin "0 1" \
    --padding "0 2" \
    "WIZADO" \
    "Steam Gaming Mode"

echo ""
gum style --foreground "$status_color" "  $status_text"
echo ""

choice=$(gum choose \
    --cursor.foreground 212 \
    --selected.foreground 212 \
    "> Launch Steam" \
    "  Settings" \
    "  Setup System" \
    "  Activate License" \
    "  Status" \
    "----------------" \
    "x Exit")

case "$choice" in
    "> Launch Steam")
        clear
        echo ""
        gum style --foreground 212 "Launching Steam..."
        sleep 0.5
        exec wizado
        ;;
    "  Settings")
        exec wizado config
        ;;
    "  Setup System")
        clear
        wizado setup
        echo ""
        gum input --placeholder "Press Enter to close..."
        ;;
    "  Activate License")
        clear
        echo ""
        email=$(gum input --placeholder "your@email.com" --header "Enter email:")
        if [[ -n "$email" ]]; then
            key=$(gum input --placeholder "XXXX-XXXX-XXXX" --header "Enter license key:")
            if [[ -n "$key" ]]; then
                echo ""
                wizado activate "$email" "$key"
                echo ""
                gum input --placeholder "Press Enter to close..."
            fi
        fi
        ;;
    "  Status")
        clear
        echo ""
        gum style --foreground 212 --bold "License Status"
        echo ""
        wizado status | jq -r '.tooltip' | sed 's/\\n/\n/g'
        echo ""
        echo "Machine ID: $(cat ~/.config/wizado/license.json 2>/dev/null | jq -r '.machineId // "N/A"' | head -c 16)..."
        echo ""
        gum input --placeholder "Press Enter to close..."
        ;;
    *)
        exit 0
        ;;
esac

