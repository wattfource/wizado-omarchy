#!/usr/bin/env bash
set -euo pipefail

# wizado: launch Steam Big Picture Mode with Gamescope
# Runs nested in Hyprland with proper ultrawide support
#
# EXIT: Steam menu → Power → Exit

STATE_DIR="${HOME}/.cache/wizado"
LOG_FILE="${STATE_DIR}/wizado.log"

mkdir -p "$STATE_DIR"

log() {
  echo "[$(date -Is)] $*" >> "$LOG_FILE" 2>/dev/null || true
}

die() {
  echo "[wizado] ERROR: $1" >&2
  exit 1
}

# Check requirements
command -v steam >/dev/null 2>&1 || die "Steam not installed"
command -v gamescope >/dev/null 2>&1 || die "Gamescope not installed (pacman -S gamescope)"

log "Starting Steam Big Picture with Gamescope"

# Stop hypridle
if pgrep -x hypridle >/dev/null 2>&1; then
  pkill hypridle 2>/dev/null || true
  echo "1" > "${STATE_DIR}/hypridle_was_running"
else
  echo "0" > "${STATE_DIR}/hypridle_was_running"
fi

# Shutdown existing Steam
if pgrep -x steam >/dev/null 2>&1; then
  steam -shutdown 2>/dev/null || true
  sleep 2
  pkill -9 steam 2>/dev/null || true
  pkill -9 steamwebhelper 2>/dev/null || true
fi

# Clean stale locks
rm -f /run/user/"$(id -u)"/gamescope-*.lock 2>/dev/null || true

# Detect GPU and resolution
NVIDIA_VK_ID=""
if lspci 2>/dev/null | grep -iq nvidia; then
  NVIDIA_VK_ID=$(lspci -nn 2>/dev/null | grep -i "NVIDIA" | grep -oP '\[10de:[0-9a-f]{4}\]' | head -n1 | tr -d '[]' || true)
  export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json
  export __GLX_VENDOR_LIBRARY_NAME=nvidia
  export WLR_NO_HARDWARE_CURSORS=1
  export __GL_SHADER_DISK_CACHE=1
  log "NVIDIA detected: $NVIDIA_VK_ID"
fi

# Get current resolution
if command -v wlr-randr >/dev/null 2>&1; then
  RES=$(wlr-randr 2>/dev/null | grep -oP '\d+x\d+' | head -1 || echo "")
fi
RES="${RES:-5120x2160}"
WIDTH="${RES%x*}"
HEIGHT="${RES#*x}"
log "Resolution: ${WIDTH}x${HEIGHT}"

# Gamescope args
GAMESCOPE_ARGS=(
  -W "$WIDTH"            # Output width
  -H "$HEIGHT"           # Output height  
  -w "$WIDTH"            # Game width
  -h "$HEIGHT"           # Game height
  -f                     # Fullscreen
  -e                     # Steam integration
  --force-grab-cursor    # Fix mouse capture
  --expose-wayland       # Native Wayland for supported games
)

# Add NVIDIA device if detected
[[ -n "$NVIDIA_VK_ID" ]] && GAMESCOPE_ARGS+=(--prefer-vk-device "$NVIDIA_VK_ID")

export SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS=0

# Cleanup on exit
cleanup() {
  log "Session ended"
  if [[ "$(cat "${STATE_DIR}/hypridle_was_running" 2>/dev/null)" == "1" ]]; then
    hypridle &
  fi
}
trap cleanup EXIT

echo ""
echo "  ╔═══════════════════════════════════════════╗"
echo "  ║      WIZADO - STEAM + GAMESCOPE           ║"
echo "  ║                                           ║"
echo "  ║  Resolution: ${WIDTH}x${HEIGHT}                   ║"
echo "  ║  Exit: Steam menu → Power → Exit          ║"
echo "  ╚═══════════════════════════════════════════╝"
echo ""

# Launch with GameMode if available
STEAM_CMD="steam -tenfoot -gamepadui"

log "gamescope ${GAMESCOPE_ARGS[*]} -- $STEAM_CMD"

if command -v gamemoderun >/dev/null 2>&1; then
  gamemoderun gamescope "${GAMESCOPE_ARGS[@]}" -- $STEAM_CMD 2>&1 | tee -a "$LOG_FILE"
else
  gamescope "${GAMESCOPE_ARGS[@]}" -- $STEAM_CMD 2>&1 | tee -a "$LOG_FILE"
fi
