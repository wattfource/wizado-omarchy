#!/usr/bin/env bash
set -euo pipefail

# wizado: launch Steam in gamescope "couch mode"
# - Default: nested gamescope under the current Wayland compositor (Hyprland)
# - Optional: exclusive TTY mode (no compositor overhead) via ~/.gaming-mode.conf

STATE_DIR="${HOME}/.cache/wizado"
SESSION_FILE="${STATE_DIR}/session.pid"
LOG_FILE="${STATE_DIR}/enter-gamesmode.log"
MODE_FILE="${STATE_DIR}/mode"
VT_FILE="${STATE_DIR}/vt"

mkdir -p "$STATE_DIR"

steam_args="-gamepadui"
gamesmode_mode="nested" # nested|tty
gamesmode_vt="2"

usage() {
  cat <<'EOF'
enter-gamesmode (wizado)

Usage:
  enter-gamesmode [--mode nested|tty] [--vt N] [--steam-mode gamepadui|bigpicture]

Notes:
  - nested: runs gamescope under your current compositor (Hyprland). No sudo required.
  - tty: runs gamescope on a TTY using the DRM backend (no Hyprland compositor overhead).
         Requires passwordless sudo for /usr/bin/openvt and /usr/bin/chvt (installed by setup.sh).
EOF
}

cli_mode=""
cli_vt=""
cli_steam_mode=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --mode) cli_mode="${2:-}"; shift 2 ;;
    --vt) cli_vt="${2:-}"; shift 2 ;;
    --steam-mode) cli_steam_mode="${2:-}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "[wizado] Unknown arg: $1" >&2; usage; exit 2 ;;
  esac
done

if [[ -f "${HOME}/.gaming-mode.conf" ]]; then
  # shellcheck disable=SC1090
  source "${HOME}/.gaming-mode.conf" 2>/dev/null || true
  case "${STEAM_LAUNCH_MODE:-}" in
    gamepadui|GAMEPADUI) steam_args="-gamepadui" ;;
    bigpicture|BIGPICTURE) steam_args="-tenfoot" ;;
  esac
  case "${GAMESMODE_MODE:-}" in
    tty|TTY|exclusive|EXCLUSIVE) gamesmode_mode="tty" ;;
    nested|NESTED) gamesmode_mode="nested" ;;
  esac
  if [[ -n "${GAMESMODE_VT:-}" ]]; then
    gamesmode_vt="${GAMESMODE_VT}"
  fi
  if [[ -n "${GAMESMODE_INTERNAL_W:-}" && -n "${GAMESMODE_INTERNAL_H:-}" ]]; then
     game_w="${GAMESMODE_INTERNAL_W}"
     game_h="${GAMESMODE_INTERNAL_H}"
     custom_res=1
  fi
fi

if [[ -n "$cli_steam_mode" ]]; then
  case "${cli_steam_mode,,}" in
    gamepadui) steam_args="-gamepadui" ;;
    bigpicture) steam_args="-tenfoot" ;;
    *) echo "[wizado] Invalid --steam-mode: $cli_steam_mode" >&2; exit 2 ;;
  esac
fi

if [[ -n "$cli_mode" ]]; then
  case "${cli_mode,,}" in
    nested) gamesmode_mode="nested" ;;
    tty|exclusive) gamesmode_mode="tty" ;;
    *) echo "[wizado] Invalid --mode: $cli_mode" >&2; exit 2 ;;
  esac
fi

if [[ -n "$cli_vt" ]]; then
  gamesmode_vt="$cli_vt"
fi

require_cmd() { command -v "$1" >/dev/null 2>&1 || { echo "[wizado] Missing: $1" >&2; exit 1; }; }
require_cmd gamescope
require_cmd steam
require_cmd pgrep
require_cmd pkill

gamescope_supports_arg() {
  local arg="$1"
  gamescope --help 2>&1 | grep -q -- "$arg"
}

get_display() {
  # Output: "W H R"
  local w=1920 h=1080 r=60

  if command -v hyprctl >/dev/null 2>&1 && command -v python3 >/dev/null 2>&1; then
    local j
    j="$(hyprctl monitors -j 2>/dev/null || true)"
    if [[ -n "$j" ]]; then
      read -r w h r <<<"$(echo "$j" | python3 -c "
import json,sys
try:
  d=json.load(sys.stdin)
  m=d[0] if d else {}
  w=int(m.get('width',1920))
  h=int(m.get('height',1080))
  rr=float(m.get('refreshRate',60))
  r=int(round(rr))
  print(w,h,r)
except Exception:
  print('1920 1080 60')
")"
    fi
  fi

  echo "$w $h $r"
}

read -r out_w out_h out_r <<<"$(get_display)"

# Default to native resolution
game_w="$out_w"
game_h="$out_h"

# Only if custom resolution was explicitly set via config, apply it.
if [[ "${custom_res:-0}" -eq 1 ]]; then
  # Values were already set above when loading config
  :
fi

hypridle_was_running="0"
if pgrep -x hypridle >/dev/null 2>&1; then
  hypridle_was_running="1"
  pkill hypridle 2>/dev/null || true
fi
echo "$hypridle_was_running" > "${STATE_DIR}/hypridle_was_running"

{
  echo "[$(date -Is)] enter-gamesmode start"
  echo "steam_args=${steam_args}"
  echo "mode=${gamesmode_mode} vt=${gamesmode_vt}"
  echo "output=${out_w}x${out_h}@${out_r} internal=${game_w}x${game_h}"
  echo "env: WAYLAND_DISPLAY=${WAYLAND_DISPLAY-} XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR-} DISPLAY=${DISPLAY-} XDG_SESSION_TYPE=${XDG_SESSION_TYPE-}"
} >>"$LOG_FILE" 2>/dev/null || true

# If Steam is already running, request a clean shutdown so it doesn't "reuse" the existing instance.
if pgrep -x steam >/dev/null 2>&1; then
  echo "[$(date -Is)] Steam is running, attempting clean shutdown..." >>"$LOG_FILE" 2>&1 || true
  steam -shutdown >>"$LOG_FILE" 2>&1 || true
  
  # Wait up to 10 seconds for clean shutdown
  for i in {1..20}; do
    if ! pgrep -x steam >/dev/null 2>&1; then
      echo "[$(date -Is)] Steam shut down cleanly." >>"$LOG_FILE" 2>&1 || true
      break
    fi
    sleep 0.5
  done
  
  # If still running, be more aggressive
  if pgrep -x steam >/dev/null 2>&1; then
    echo "[$(date -Is)] Steam still running, using pkill..." >>"$LOG_FILE" 2>&1 || true
    pkill -x steam 2>/dev/null || true
    sleep 2
    pkill -9 -x steam 2>/dev/null || true
    pkill -9 -x steamwebhelper 2>/dev/null || true
  fi
fi

echo "$gamesmode_mode" > "$MODE_FILE" 2>/dev/null || true
echo "$gamesmode_vt" > "$VT_FILE" 2>/dev/null || true

# Detect GPU and prepare gamescope arguments
get_gpu_args() {
  local args=()
  if command -v lspci >/dev/null 2>&1; then
    # Prefer NVIDIA if present
    local nv
    nv="$(lspci -nn | grep -i "NVIDIA" | grep -oP '\[\K[0-9a-f]{4}:[0-9a-f]{4}(?=\])' | head -n1 || true)"
    if [[ -n "$nv" ]]; then
      args+=(--prefer-vk-device "$nv")
      # NVIDIA-specific hack flag only if supported by this gamescope build.
      if gamescope_supports_arg "--nvidia-hack"; then
        args+=(--nvidia-hack)
      else
        echo "[$(date -Is)] NOTE: gamescope does not support --nvidia-hack; skipping." >>"$LOG_FILE" 2>&1 || true
      fi
      
      # Check for nvidia-drm.modeset=1 (REQUIRED for gamescope TTY mode on NVIDIA)
      if [[ "$gamesmode_mode" == "tty" ]]; then
        if ! grep -q "nvidia-drm.modeset=1" /proc/cmdline; then
           echo "[$(date -Is)] WARNING: nvidia-drm.modeset=1 is missing from kernel parameters!" >>"$LOG_FILE" 2>&1
           echo "[$(date -Is)] Optimized launch (TTY mode) WILL FAIL on NVIDIA without this." >>"$LOG_FILE" 2>&1
           echo "[$(date -Is)] Please add nvidia-drm.modeset=1 to your bootloader config." >>"$LOG_FILE" 2>&1
           tty_prereq_error "TTY mode on NVIDIA requires kernel param nvidia-drm.modeset=1. Add it, reboot, then try again."
           exit 1
        fi
      fi
    else
      # Otherwise prefer AMD if present
      local amd
      amd="$(lspci -nn | grep -iE "AMD|ATI" | grep -oP '\[\K[0-9a-f]{4}:[0-9a-f]{4}(?=\])' | head -n1 || true)"
      if [[ -n "$amd" ]]; then
        args+=(--prefer-vk-device "$amd")
      fi
    fi
  fi
  echo "${args[@]}"
}

gpu_args=($(get_gpu_args))

base_gamescope_args=(
  -e
  --keep-alive
  -f
  -w "$game_w" -h "$game_h"
  -W "$out_w" -H "$out_h"
  -r "$out_r"
  --force-grab-cursor
  --force-windows-fullscreen
  "${gpu_args[@]}"
)

# Consolidation of environment variables to prevent Vulkan layer conflicts
# and ensure Steam/Gamescope can find necessary files.
clean_vulkan_env() {
  # Disable layers that often interfere with Gamescope's own WSI layer
  export DISABLE_MANGOHUD=1
  export DISABLE_LAYER_AMD_SWITCHABLE_GRAPHICS_1=1
  export DISABLE_LAYER_NV_OPTIMUS_1=1
  export DISABLE_VK_LAYER_NV_optimus_1=1
  export DISABLE_LAYER_MESA_ANTI_LAG=1
  export NODEVICE_SELECT=1
  
  # Disable the Gamescope WSI layer by default in the parent environment.
  # Gamescope will re-enable it for the child process (Steam/game) as needed.
  export DISABLE_GAMESCOPE_WSI=1
  
  # Reset Vulkan layer paths to prevent accidental loading of global layers
  export VK_LAYER_PATH=""
  export VK_INSTANCE_LAYERS=""
}

# In exclusive TTY mode we must not inherit the desktop compositor's display env.
clean_display_env_for_tty() {
  unset DISPLAY
  unset WAYLAND_DISPLAY
}

tty_prereq_error() {
  local msg="$1"
  {
    echo "[$(date -Is)] ERROR: $msg"
  } >>"$LOG_FILE" 2>&1 || true
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "wizado" "$msg" >/dev/null 2>&1 || true
  fi
  echo "[wizado] $msg" >&2
}

# TTY mode is meant to be the "exclusive/max performance" path.
# If prerequisites are missing, do NOT silently fall back to nested.
if [[ "$gamesmode_mode" == "tty" ]]; then
  if ! sudo -n true >/dev/null 2>&1; then
    tty_prereq_error "TTY mode needs passwordless sudo for openvt/chvt. Re-run setup and install the sudoers drop-in."
    exit 1
  fi
fi

if [[ "$gamesmode_mode" == "tty" ]]; then
  # Exclusive DRM gamescope (no compositor overhead) by launching on a TTY.
  require_cmd openvt
  require_cmd chvt
  require_cmd fgconsole

  current_vt="$(fgconsole 2>/dev/null || echo "1")"
  target_vt="$gamesmode_vt"

  {
    echo "[$(date -Is)] mode=tty current_vt=${current_vt} target_vt=${target_vt}"
    echo "note: tty mode requires passwordless sudo for openvt/chvt"
  } >>"$LOG_FILE" 2>/dev/null || true

  # Passwordless sudo was already checked above; keep a defensive check here too.
  sudo -n true >/dev/null 2>&1 || {
    echo "[wizado] tty mode requires passwordless sudo for openvt/chvt (install sudoers drop-in via setup.sh)." >&2
    exit 1
  }

  user_name="$USER"
  user_id=$(id -u)

  # Launching in a subshell to handle VT switching more reliably
  (
    # Ensure Steam is REALLY gone before we switch VTs
    pkill -9 -x steam 2>/dev/null || true
    sleep 1

    echo "[$(date -Is)] Switching to VT ${target_vt}..." >>"$LOG_FILE" 2>&1
    
    # We use a sub-shell command inside openvt to ensure environment and logging are correct
    local cmd="env PATH=\"$PATH\" HOME=\"$HOME\" USER=\"$user_name\" XDG_RUNTIME_DIR=\"/run/user/$user_id\" XDG_DATA_DIRS=\"/usr/local/share:/usr/share\" DISABLE_MANGOHUD=1 DISABLE_LAYER_AMD_SWITCHABLE_GRAPHICS_1=1 DISABLE_LAYER_NV_OPTIMUS_1=1 DISABLE_VK_LAYER_NV_optimus_1=1 DISABLE_LAYER_MESA_ANTI_LAG=1 DISABLE_GAMESCOPE_WSI=1 NODEVICE_SELECT=1 VK_LAYER_PATH=\"\" VK_INSTANCE_LAYERS=\"\" DISPLAY= WAYLAND_DISPLAY= gamescope --backend drm ${base_gamescope_args[*]} -- steam ${steam_args}"

    if ! sudo openvt -c "$target_vt" -s -f -w -- sudo -u "$user_name" bash -c "$cmd" >>"$LOG_FILE" 2>&1; then
      echo "[$(date -Is)] openvt/gamescope failed with exit code $?" >>"$LOG_FILE" 2>&1
    fi
    
    # After gamescope exits or fails, switch back to the desktop VT.
    echo "[$(date -Is)] Switching back to VT ${current_vt}..." >>"$LOG_FILE" 2>&1
    sleep 1
    sudo chvt "$current_vt" >/dev/null 2>&1 || true
  ) &
  echo "$!" > "$SESSION_FILE" 2>/dev/null || true
  exit 0
fi

# Nested mode: Wayland backend tends to behave best under Hyprland; SDL is a fallback.
primary_backend=(--backend wayland --expose-wayland --allow-deferred-backend)
fallback_backend=(--backend sdl -b)

{
  echo "primary_backend=${primary_backend[*]}"
  echo "fallback_backend=${fallback_backend[*]}"
  echo "base_gamescope_args=${base_gamescope_args[*]}"
} >>"$LOG_FILE" 2>/dev/null || true

# Launch gamescope
clean_vulkan_env

{
  echo "[$(date -Is)] nested launch env: WAYLAND_DISPLAY=${WAYLAND_DISPLAY-} XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR-}"
} >>"$LOG_FILE" 2>/dev/null || true

setsid gamescope "${primary_backend[@]}" "${base_gamescope_args[@]}" -- steam ${steam_args} >>"$LOG_FILE" 2>&1 &
gs_pid=$!
echo "$gs_pid" > "$SESSION_FILE"

(
  sleep 2
  if ! kill -0 "$gs_pid" 2>/dev/null; then
    echo "[$(date -Is)] gamescope died within 2s; retrying with ${fallback_backend[*]}" >>"$LOG_FILE" 2>/dev/null || true
    clean_vulkan_env
    setsid gamescope "${fallback_backend[@]}" "${base_gamescope_args[@]}" -- steam "${steam_args}" >>"$LOG_FILE" 2>&1 &
    echo "$!" > "$SESSION_FILE" 2>/dev/null || true
  fi
) >/dev/null 2>&1 &

exit 0


