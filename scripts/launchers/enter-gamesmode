#!/usr/bin/env bash
set -euo pipefail

# wizado: launch Steam in gamescope (nested mode under Hyprland)

STATE_DIR="${HOME}/.cache/wizado"
SESSION_FILE="${STATE_DIR}/session.pid"
LOG_FILE="${STATE_DIR}/enter-gamesmode.log"

mkdir -p "$STATE_DIR"

log() {
  echo "[$(date -Is)] $*" >> "$LOG_FILE" 2>/dev/null || true
}

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "[wizado] Missing required command: $1" >&2
    exit 1
  }
}

get_display() {
  # Output: "W H R" (width height refresh)
  local w=1920 h=1080 r=60

  if command -v hyprctl >/dev/null 2>&1 && command -v python3 >/dev/null 2>&1; then
    local j
    j="$(hyprctl monitors -j 2>/dev/null || true)"
    if [[ -n "$j" ]]; then
      read -r w h r <<< "$(echo "$j" | python3 -c "
import json, sys
try:
    d = json.load(sys.stdin)
    m = d[0] if d else {}
    w = int(m.get('width', 1920))
    h = int(m.get('height', 1080))
    r = int(round(m.get('refreshRate', 60)))
    print(w, h, r)
except Exception:
    print('1920 1080 60')
")"
    fi
  fi

  echo "$w $h $r"
}

require_cmd steam
require_cmd gamescope
require_cmd pgrep
require_cmd pkill

# Get display info
read -r WIDTH HEIGHT REFRESH <<< "$(get_display)"

log "Starting enter-gamesmode"
log "Display: ${WIDTH}x${HEIGHT}@${REFRESH}Hz"

# Stop hypridle during gaming to prevent screen blanking
hypridle_was_running="0"
if pgrep -x hypridle >/dev/null 2>&1; then
  hypridle_was_running="1"
  pkill hypridle 2>/dev/null || true
  log "Stopped hypridle"
fi
echo "$hypridle_was_running" > "${STATE_DIR}/hypridle_was_running"

# If Steam is already running, shut it down cleanly first
if pgrep -x steam >/dev/null 2>&1; then
  log "Steam already running, shutting down..."
  steam -shutdown >/dev/null 2>&1 || true
  
  # Wait for clean shutdown
  for _ in {1..20}; do
    pgrep -x steam >/dev/null 2>&1 || break
    sleep 0.5
  done
  
  # Force kill if still running
  if pgrep -x steam >/dev/null 2>&1; then
    pkill -9 -x steam 2>/dev/null || true
    pkill -9 -x steamwebhelper 2>/dev/null || true
  fi
fi

# Clean up any stale gamescope locks
rm -f /run/user/"$(id -u)"/gamescope-*.lock 2>/dev/null || true

# Build gamescope arguments
# Reference: https://github.com/ValveSoftware/gamescope
GAMESCOPE_ARGS=(
  -e                            # Steam integration mode (exposes special Wayland protocols)
  -f                            # Start in fullscreen
  -w "$WIDTH" -h "$HEIGHT"      # Internal (game render) resolution
  -W "$WIDTH" -H "$HEIGHT"      # Output (window) resolution  
  -r "$REFRESH"                 # Refresh rate limit
  --force-grab-cursor           # Capture cursor in gamescope window
)

# Steam arguments
# -steamdeck: Enables Steam Deck UI mode, designed for gamescope integration
# This provides better controller support and gamescope-aware features
STEAM_ARGS="-steamdeck -steamos3"

# Environment variables for proper integration
export SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS=0

# If gamemode is available, configure Steam to use it for games
# Note: gamemoderun should wrap the GAME, not gamescope itself
# Steam will use gamemode automatically if lib32-gamemode is installed
# and games are launched with gamemoderun in their launch options
if command -v gamemoderun >/dev/null 2>&1; then
  # Enable gamemode integration in Steam
  export STEAM_RUNTIME_PREFER_HOST_LIBRARIES=0
  log "Gamemode available - games can use gamemoderun in launch options"
fi

# If MangoHud is available, enable it via gamescope
if command -v mangohud >/dev/null 2>&1; then
  GAMESCOPE_ARGS+=(--mangoapp)
  log "MangoHud enabled via --mangoapp"
fi

log "Launching: gamescope ${GAMESCOPE_ARGS[*]} -- steam $STEAM_ARGS"

# Launch gamescope with Steam
# Note: We don't wrap gamescope with gamemoderun because:
# 1. Gamemode should optimize the actual games, not the compositor
# 2. Steam handles gamemode integration for individual games
setsid /usr/bin/gamescope "${GAMESCOPE_ARGS[@]}" -- /usr/bin/steam $STEAM_ARGS >> "$LOG_FILE" 2>&1 &
GAMESCOPE_PID=$!

echo "$GAMESCOPE_PID" > "$SESSION_FILE"
log "Gamescope started with PID $GAMESCOPE_PID"

exit 0
