#!/usr/bin/env bash
set -euo pipefail

# wizado: launch Steam in gamescope on dedicated TTY (bypasses Hyprland)
# Maximum performance mode - gamescope runs as standalone compositor

STATE_DIR="${HOME}/.cache/wizado"
CONFIG_DIR="${HOME}/.local/share/steam-launcher"
SESSION_FILE="${STATE_DIR}/session.pid"
TTY_FILE="${STATE_DIR}/original_tty"
LOG_FILE="${STATE_DIR}/enter-gamesmode-tty.log"
HARDWARE_CONF="${CONFIG_DIR}/hardware.conf"
GAMING_TTY=2

mkdir -p "$STATE_DIR"

log() {
  echo "[$(date -Is)] $*" >> "$LOG_FILE" 2>/dev/null || true
}

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "[wizado] Missing required command: $1" >&2
    exit 1
  }
}

get_current_tty() {
  # Get the current TTY number
  local tty_path
  tty_path=$(tty 2>/dev/null || echo "")
  if [[ "$tty_path" =~ /dev/tty([0-9]+) ]]; then
    echo "${BASH_REMATCH[1]}"
  elif [[ -n "${XDG_VTNR:-}" ]]; then
    echo "$XDG_VTNR"
  else
    # Default to TTY1 if we can't detect
    echo "1"
  fi
}

get_display() {
  # Get display info from hardware config or use defaults
  local w=1920 h=1080 r=60

  # Try to get from drm if available
  for connector in /sys/class/drm/card*-*/modes; do
    if [[ -f "$connector" ]]; then
      local mode
      mode=$(head -n1 "$connector" 2>/dev/null || true)
      if [[ "$mode" =~ ^([0-9]+)x([0-9]+) ]]; then
        w="${BASH_REMATCH[1]}"
        h="${BASH_REMATCH[2]}"
        break
      fi
    fi
  done

  # Try to get refresh rate from edid or default
  for connector in /sys/class/drm/card*-*/status; do
    local dir
    dir=$(dirname "$connector")
    if [[ -f "$dir/modes" ]] && grep -q "^${w}x${h}" "$dir/modes" 2>/dev/null; then
      # Parse refresh from mode string like "1920x1080@144"
      local mode_line
      mode_line=$(grep "^${w}x${h}" "$dir/modes" 2>/dev/null | head -n1 || true)
      if [[ "$mode_line" =~ @([0-9]+) ]]; then
        r="${BASH_REMATCH[1]}"
      fi
      break
    fi
  done

  echo "$w $h $r"
}

# Load hardware config from setup
load_hardware_config() {
  HAS_NVIDIA=false
  HAS_AMD=false
  HAS_INTEL=false
  NVIDIA_VK_ID=""
  
  if [[ -f "$HARDWARE_CONF" ]]; then
    source "$HARDWARE_CONF"
    log "Loaded hardware config: NVIDIA=$HAS_NVIDIA AMD=$HAS_AMD INTEL=$HAS_INTEL"
  else
    # Fallback: detect GPUs
    if command -v lspci >/dev/null 2>&1; then
      if lspci | grep -iq nvidia; then
        HAS_NVIDIA=true
        NVIDIA_VK_ID=$(lspci -nn | grep -i "NVIDIA" | grep -oP '\[10de:[0-9a-f]{4}\]' | head -n1 | tr -d '[]')
      fi
      if lspci | grep -iqE 'amd|radeon'; then
        HAS_AMD=true
      fi
    fi
    log "Hardware detected dynamically: NVIDIA=$HAS_NVIDIA AMD=$HAS_AMD"
  fi
}

# Set NVIDIA GPU to maximum performance mode
set_nvidia_performance() {
  $HAS_NVIDIA || return 0
  
  if command -v nvidia-settings >/dev/null 2>&1; then
    local current_mode
    current_mode=$(nvidia-settings -q '[gpu:0]/GpuPowerMizerMode' 2>/dev/null | grep -oP 'GpuPowerMizerMode.*: \K[0-9]+' || echo "0")
    echo "$current_mode" > "${STATE_DIR}/nvidia_powermizer_mode"
    nvidia-settings -a '[gpu:0]/GpuPowerMizerMode=1' >/dev/null 2>&1 || true
    log "Set NVIDIA PowerMizer to Performance mode (was: $current_mode)"
  fi
  
  if command -v nvidia-smi >/dev/null 2>&1; then
    nvidia-smi -pm 1 >/dev/null 2>&1 || true
    log "Enabled NVIDIA persistence mode"
  fi
}

# Set AMD GPU to high performance
set_amd_performance() {
  $HAS_AMD || return 0
  
  for card in /sys/class/drm/card*/device/power_dpm_force_performance_level; do
    if [[ -f "$card" ]] && [[ -w "$card" ]]; then
      local current_level
      current_level=$(cat "$card" 2>/dev/null || echo "auto")
      echo "$card:$current_level" >> "${STATE_DIR}/amd_perf_levels"
      echo "high" > "$card" 2>/dev/null || true
      log "Set AMD performance level to high (was: $current_level)"
    fi
  done
}

# The actual gamescope session that runs on the gaming TTY
run_gamescope_session() {
  local width="$1"
  local height="$2"
  local refresh="$3"
  local original_tty="$4"

  # Build gamescope arguments for standalone mode
  local -a GAMESCOPE_ARGS=(
    -f                            # Fullscreen (not borderless - we ARE the compositor)
    -e                            # Steam integration mode
    -w "$width" -h "$height"      # Internal resolution
    -W "$width" -H "$height"      # Output resolution
    -r "$refresh"                 # Refresh rate
    --force-grab-cursor           # Capture cursor
    --xwayland-count 2            # Extra XWayland for stability
  )

  # Prefer NVIDIA GPU
  if $HAS_NVIDIA && [[ -n "$NVIDIA_VK_ID" ]]; then
    GAMESCOPE_ARGS+=(--prefer-vk-device "$NVIDIA_VK_ID")
  fi

  # MangoHud integration
  if command -v mangohud >/dev/null 2>&1; then
    GAMESCOPE_ARGS+=(--mangoapp)
  fi

  # Environment for standalone compositor
  export XDG_SESSION_TYPE=wayland
  export SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS=0
  export STEAM_RUNTIME_PREFER_HOST_LIBRARIES=0

  # NVIDIA environment
  if $HAS_NVIDIA; then
    export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json
    export __GLX_VENDOR_LIBRARY_NAME=nvidia
    export __VK_LAYER_NV_optimus=NVIDIA_only
  fi

  log "Running gamescope session: ${GAMESCOPE_ARGS[*]}"

  # Run gamescope - when it exits, we return to original TTY
  /usr/bin/gamescope "${GAMESCOPE_ARGS[@]}" -- /usr/bin/steam -tenfoot

  # Gamescope exited - return to original TTY
  log "Gamescope exited, returning to TTY $original_tty"
  sudo chvt "$original_tty" 2>/dev/null || chvt "$original_tty" 2>/dev/null || true

  # Cleanup
  rm -f "$SESSION_FILE" "$TTY_FILE"
}

# Main entry point
main() {
  require_cmd steam
  require_cmd gamescope
  require_cmd chvt

  # Load hardware configuration
  load_hardware_config

  # Get display info
  read -r WIDTH HEIGHT REFRESH <<< "$(get_display)"

  log "Starting TTY gaming mode"
  log "Display: ${WIDTH}x${HEIGHT}@${REFRESH}Hz"
  log "Hardware: NVIDIA=$HAS_NVIDIA AMD=$HAS_AMD INTEL=$HAS_INTEL"

  # Save original TTY for return
  ORIGINAL_TTY=$(get_current_tty)
  echo "$ORIGINAL_TTY" > "$TTY_FILE"
  log "Original TTY: $ORIGINAL_TTY, Gaming TTY: $GAMING_TTY"

  # Mark that we're in TTY mode
  echo "tty" > "${STATE_DIR}/gaming_mode"

  # Stop hypridle during gaming
  hypridle_was_running="0"
  if pgrep -x hypridle >/dev/null 2>&1; then
    hypridle_was_running="1"
    pkill hypridle 2>/dev/null || true
    log "Stopped hypridle"
  fi
  echo "$hypridle_was_running" > "${STATE_DIR}/hypridle_was_running"

  # Shutdown existing Steam
  if pgrep -x steam >/dev/null 2>&1; then
    log "Steam already running, shutting down..."
    steam -shutdown >/dev/null 2>&1 || true
    for _ in {1..20}; do
      pgrep -x steam >/dev/null 2>&1 || break
      sleep 0.5
    done
    if pgrep -x steam >/dev/null 2>&1; then
      pkill -9 -x steam 2>/dev/null || true
      pkill -9 -x steamwebhelper 2>/dev/null || true
    fi
  fi

  # Clean up stale locks
  rm -f /run/user/"$(id -u)"/gamescope-*.lock 2>/dev/null || true

  # Apply GPU performance settings
  rm -f "${STATE_DIR}/nvidia_powermizer_mode" "${STATE_DIR}/amd_perf_levels" 2>/dev/null || true
  set_nvidia_performance
  set_amd_performance

  # Create the session script that will run on the gaming TTY
  local session_script="${STATE_DIR}/gamescope-session.sh"
  cat > "$session_script" <<SESSIONEOF
#!/usr/bin/env bash
set -euo pipefail

# Source this script's functions
export HOME="$HOME"
export USER="$USER"
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
export PATH="$PATH"

# Hardware config
HAS_NVIDIA=$HAS_NVIDIA
HAS_AMD=$HAS_AMD
NVIDIA_VK_ID="$NVIDIA_VK_ID"

# Gamescope arguments
GAMESCOPE_ARGS=(
  -f
  -e
  -w $WIDTH -h $HEIGHT
  -W $WIDTH -H $HEIGHT
  -r $REFRESH
  --force-grab-cursor
  --xwayland-count 2
)

if \$HAS_NVIDIA && [[ -n "\$NVIDIA_VK_ID" ]]; then
  GAMESCOPE_ARGS+=(--prefer-vk-device "\$NVIDIA_VK_ID")
fi

if command -v mangohud >/dev/null 2>&1; then
  GAMESCOPE_ARGS+=(--mangoapp)
fi

export XDG_SESSION_TYPE=wayland
export SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS=0
export STEAM_RUNTIME_PREFER_HOST_LIBRARIES=0

if \$HAS_NVIDIA; then
  export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json
  export __GLX_VENDOR_LIBRARY_NAME=nvidia
  export __VK_LAYER_NV_optimus=NVIDIA_only
fi

# Log start
echo "[TTY Session] Starting gamescope: \${GAMESCOPE_ARGS[*]}" >> "$LOG_FILE"

# Run gamescope
/usr/bin/gamescope "\${GAMESCOPE_ARGS[@]}" -- /usr/bin/steam -tenfoot

# When done, switch back
echo "[TTY Session] Gamescope exited, returning to TTY $ORIGINAL_TTY" >> "$LOG_FILE"
sudo chvt $ORIGINAL_TTY 2>/dev/null || chvt $ORIGINAL_TTY 2>/dev/null || true

# Cleanup
rm -f "$SESSION_FILE" "${STATE_DIR}/gaming_mode"
SESSIONEOF
  chmod +x "$session_script"

  log "Switching to TTY $GAMING_TTY"
  
  # Use openvt to run the session on the gaming TTY
  # -c: specify TTY number
  # -s: switch to the new TTY
  # -w: wait for the command to complete (in background for us)
  # --: run as current user
  sudo openvt -c "$GAMING_TTY" -s -w -- sudo -u "$USER" "$session_script" &
  local openvt_pid=$!
  
  echo "$openvt_pid" > "$SESSION_FILE"
  log "Gaming session started with PID $openvt_pid"

  exit 0
}

main "$@"

