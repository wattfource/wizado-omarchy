#!/usr/bin/env bash
set -euo pipefail

# wizado: exit gamescope gaming mode and return to desktop
# Handles both nested (Hyprland) and dedicated TTY modes

STATE_DIR="${HOME}/.cache/wizado"
SESSION_FILE="${STATE_DIR}/session.pid"
TTY_FILE="${STATE_DIR}/original_tty"
GAMING_MODE_FILE="${STATE_DIR}/gaming_mode"

# Detect gaming mode type
get_gaming_mode() {
  if [[ -f "$GAMING_MODE_FILE" ]]; then
    cat "$GAMING_MODE_FILE" 2>/dev/null || echo "nested"
  else
    echo "nested"
  fi
}

# Restore NVIDIA PowerMizer mode
restore_nvidia_settings() {
  if [[ -f "${STATE_DIR}/nvidia_powermizer_mode" ]]; then
    local original_mode
    original_mode=$(cat "${STATE_DIR}/nvidia_powermizer_mode" 2>/dev/null || echo "0")
    
    if command -v nvidia-settings >/dev/null 2>&1; then
      nvidia-settings -a "[gpu:0]/GpuPowerMizerMode=$original_mode" >/dev/null 2>&1 || true
    fi
    
    # Note: We don't disable persistence mode as it's set system-wide by setup
    
    rm -f "${STATE_DIR}/nvidia_powermizer_mode"
  fi
}

# Restore AMD GPU performance levels
restore_amd_settings() {
  if [[ -f "${STATE_DIR}/amd_perf_levels" ]]; then
    while IFS=: read -r path level; do
      if [[ -f "$path" ]] && [[ -w "$path" ]] && [[ -n "$level" ]]; then
        echo "$level" > "$path" 2>/dev/null || true
      fi
    done < "${STATE_DIR}/amd_perf_levels"
    rm -f "${STATE_DIR}/amd_perf_levels"
  fi
}

# Switch back to original TTY (for TTY mode)
switch_to_original_tty() {
  if [[ -f "$TTY_FILE" ]]; then
    local original_tty
    original_tty=$(cat "$TTY_FILE" 2>/dev/null || echo "1")
    
    if [[ -n "$original_tty" ]] && [[ "$original_tty" =~ ^[0-9]+$ ]]; then
      # Try with sudo first, then without
      sudo chvt "$original_tty" 2>/dev/null || chvt "$original_tty" 2>/dev/null || true
    fi
    
    rm -f "$TTY_FILE"
  fi
}

# Get gaming mode
GAMING_MODE=$(get_gaming_mode)

# Gracefully shutdown Steam first
if pgrep -x steam >/dev/null 2>&1; then
  steam -shutdown >/dev/null 2>&1 || true
  
  # Wait for clean shutdown
  for _ in {1..10}; do
    pgrep -x steam >/dev/null 2>&1 || break
    sleep 0.5
  done
fi

# Force kill Steam if still running
pkill -x steam 2>/dev/null || true
pkill -x steamwebhelper 2>/dev/null || true
sleep 0.5
pkill -9 -x steam 2>/dev/null || true
pkill -9 -x steamwebhelper 2>/dev/null || true

# Kill gamescope
pkill -x gamescope 2>/dev/null || true
pkill -x gamescopereaper 2>/dev/null || true
sleep 0.5
pkill -9 -x gamescope 2>/dev/null || true
pkill -9 -x gamescopereaper 2>/dev/null || true

# Kill session PID if recorded
if [[ -f "$SESSION_FILE" ]]; then
  pid="$(cat "$SESSION_FILE" 2>/dev/null || true)"
  if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
    kill "$pid" 2>/dev/null || true
    sleep 0.5
    kill -9 "$pid" 2>/dev/null || true
  fi
  rm -f "$SESSION_FILE"
fi

# Clean up TTY session script if it exists
rm -f "${STATE_DIR}/gamescope-session.sh" 2>/dev/null || true

# Clean up stale locks
rm -f /run/user/"$(id -u)"/gamescope-*.lock 2>/dev/null || true

# Restore GPU settings
restore_nvidia_settings
restore_amd_settings

# Switch back to original TTY if we were in TTY mode
if [[ "$GAMING_MODE" == "tty" ]]; then
  switch_to_original_tty
fi

# Clean up gaming mode marker
rm -f "$GAMING_MODE_FILE" 2>/dev/null || true

# Restart hypridle if it was running before gaming mode
if [[ -f "${STATE_DIR}/hypridle_was_running" ]]; then
  was="$(cat "${STATE_DIR}/hypridle_was_running" 2>/dev/null || echo "0")"
  if [[ "$was" == "1" ]] && command -v hypridle >/dev/null 2>&1; then
    if ! pgrep -x hypridle >/dev/null 2>&1; then
      nohup hypridle >/dev/null 2>&1 &
      disown || true
    fi
  fi
  rm -f "${STATE_DIR}/hypridle_was_running"
fi

exit 0
