#!/usr/bin/env bash
set -euo pipefail

# wizado: Steam gaming launcher for Hyprland
# Launches Steam+gamescope in a dedicated workspace

CONFIG_FILE="${HOME}/.config/wizado/config"
STATE_DIR="${HOME}/.cache/wizado"
LOG_FILE="${STATE_DIR}/wizado.log"

mkdir -p "$STATE_DIR"

# Clear log on each startup
> "$LOG_FILE"

log() { 
  echo "[$(date '+%H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

log "========== WIZADO STARTING =========="
log "PID: $$"
log "WAYLAND_DISPLAY: ${WAYLAND_DISPLAY:-unset}"

# Load config (with defaults)
WIZADO_RESOLUTION=auto
WIZADO_FSR=off
WIZADO_FRAMELIMIT=0
WIZADO_VRR=off
WIZADO_HDR=off
WIZADO_MANGOHUD=off
WIZADO_STEAM_UI=tenfoot
WIZADO_WORKSPACE=10

if [[ -f "$CONFIG_FILE" ]]; then
  log "Loading config from $CONFIG_FILE"
  source "$CONFIG_FILE"
else
  log "No config file, using defaults"
fi

# Ensure we're in Hyprland
if [[ -z "${WAYLAND_DISPLAY:-}" ]]; then
  log "ERROR: No WAYLAND_DISPLAY - must run from Hyprland"
  echo "Error: Must run from Hyprland"
  exit 1
fi

# Requirements check
command -v steam >/dev/null 2>&1 || { log "ERROR: Steam not installed"; echo "Error: Steam not installed"; exit 1; }
command -v gamescope >/dev/null 2>&1 || { log "ERROR: Gamescope not installed"; echo "Error: Gamescope not installed"; exit 1; }
command -v hyprctl >/dev/null 2>&1 || { log "ERROR: hyprctl not found"; echo "Error: hyprctl not found"; exit 1; }

# Find an empty workspace or use configured one
find_workspace() {
  # Get list of workspaces with windows
  local used_workspaces
  used_workspaces=$(hyprctl workspaces -j 2>/dev/null | grep -oP '"id":\s*\K\d+' | sort -n)
  
  # Check if configured workspace is empty
  if ! echo "$used_workspaces" | grep -q "^${WIZADO_WORKSPACE}$"; then
    echo "$WIZADO_WORKSPACE"
    return
  fi
  
  # Find first empty workspace between 1-10
  for ws in {1..10}; do
    if ! echo "$used_workspaces" | grep -q "^${ws}$"; then
      echo "$ws"
      return
    fi
  done
  
  # Fallback to configured workspace
  echo "$WIZADO_WORKSPACE"
}

# Detect NVIDIA GPU
NVIDIA_VK_ID=""
if lspci 2>/dev/null | grep -iq nvidia; then
  NVIDIA_VK_ID=$(lspci -nn 2>/dev/null | grep -i "NVIDIA" | grep -oP '\[10de:[0-9a-f]{4}\]' | head -n1 | tr -d '[]' || true)
  log "NVIDIA detected: $NVIDIA_VK_ID"
fi

# Get monitor resolution
if [[ "$WIZADO_RESOLUTION" == "auto" ]]; then
  RES=$(hyprctl monitors -j 2>/dev/null | grep -oP '"width":\s*\K\d+' | head -1 || echo "2560")
  HEIGHT=$(hyprctl monitors -j 2>/dev/null | grep -oP '"height":\s*\K\d+' | head -1 || echo "1440")
  WIDTH="$RES"
else
  WIDTH="${WIZADO_RESOLUTION%x*}"
  HEIGHT="${WIZADO_RESOLUTION#*x}"
fi
log "Resolution: ${WIDTH}x${HEIGHT}"

# Build gamescope args
GS_ARGS=(-W "$WIDTH" -H "$HEIGHT" -f -e --grab --force-windows-fullscreen --disable-color-management)

# FSR scaling
if [[ "$WIZADO_FSR" != "off" ]]; then
  case "$WIZADO_FSR" in
    ultra) scale="0.77" ;;
    quality) scale="0.67" ;;
    balanced) scale="0.59" ;;
    performance) scale="0.5" ;;
    *) scale="1.0" ;;
  esac
  inner_w=$(echo "$WIDTH * $scale" | bc | cut -d. -f1)
  inner_h=$(echo "$HEIGHT * $scale" | bc | cut -d. -f1)
  GS_ARGS+=(-w "$inner_w" -h "$inner_h" --filter fsr)
  log "FSR: ${WIZADO_FSR} (render: ${inner_w}x${inner_h})"
else
  GS_ARGS+=(-w "$WIDTH" -h "$HEIGHT")
fi

# Optional features
[[ "$WIZADO_FRAMELIMIT" != "0" ]] && GS_ARGS+=(--framerate-limit "$WIZADO_FRAMELIMIT")
[[ "$WIZADO_VRR" == "on" ]] && GS_ARGS+=(--adaptive-sync)
[[ -n "$NVIDIA_VK_ID" ]] && GS_ARGS+=(--prefer-vk-device "$NVIDIA_VK_ID")

log "Gamescope args: ${GS_ARGS[*]}"

# Kill any existing Steam
pkill -9 steam 2>/dev/null || true
pkill -9 steamwebhelper 2>/dev/null || true
sleep 0.5

# Stop hypridle if running
HYPRIDLE_WAS_RUNNING=0
if pgrep -x hypridle >/dev/null 2>&1; then
  pkill hypridle 2>/dev/null || true
  HYPRIDLE_WAS_RUNNING=1
  log "Stopped hypridle"
fi

# Save current workspace to return to later
ORIGINAL_WORKSPACE=$(hyprctl activeworkspace -j 2>/dev/null | grep -oP '"id":\s*\K\d+' || echo "1")
log "Current workspace: $ORIGINAL_WORKSPACE"

# Find target workspace
TARGET_WS=$(find_workspace)
log "Target workspace: $TARGET_WS"

# Set up environment
[[ "$WIZADO_MANGOHUD" == "on" ]] && export MANGOHUD=1 || export MANGOHUD=0
export SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS=0

if [[ -n "$NVIDIA_VK_ID" ]]; then
  export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json
  export __GLX_VENDOR_LIBRARY_NAME=nvidia
  export __GL_SHADER_DISK_CACHE=1
  export WLR_NO_HARDWARE_CURSORS=1
  export XCURSOR_SIZE=24
  log "NVIDIA environment configured"
fi

# Switch to gaming workspace
log "Switching to workspace $TARGET_WS"
hyprctl dispatch workspace "$TARGET_WS" >/dev/null 2>&1

# Cleanup function
cleanup() {
  log "Cleanup: Steam session ended"
  
  # Return to original workspace
  hyprctl dispatch workspace "$ORIGINAL_WORKSPACE" >/dev/null 2>&1
  log "Returned to workspace $ORIGINAL_WORKSPACE"
  
  # Restart hypridle if it was running
  if [[ "$HYPRIDLE_WAS_RUNNING" == "1" ]]; then
    hypridle &
    log "Restarted hypridle"
  fi
}
trap cleanup EXIT

# Launch gamescope + Steam
log "Launching: gamescope ${GS_ARGS[*]} -- steam -${WIZADO_STEAM_UI}"

gamescope "${GS_ARGS[@]}" -- steam -"${WIZADO_STEAM_UI}" 2>&1 | tee -a "$LOG_FILE"
EXIT_CODE=${PIPESTATUS[0]}

log "Gamescope exited with code: $EXIT_CODE"
