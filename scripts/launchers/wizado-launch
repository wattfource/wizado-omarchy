#!/usr/bin/env bash
set -euo pipefail

# wizado-launch: License-gated launcher for wizado
# Used by waybar and keybindings to launch Steam gaming mode

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Source license functions
if [[ -f "${LIB_DIR}/license.sh" ]]; then
  source "${LIB_DIR}/license.sh"
elif [[ -f "/usr/share/wizado/scripts/lib/license.sh" ]]; then
  source "/usr/share/wizado/scripts/lib/license.sh"
else
  echo "Error: Cannot find license.sh" >&2
  exit 1
fi

if [[ -f "${LIB_DIR}/license-tui.sh" ]]; then
  source "${LIB_DIR}/license-tui.sh"
elif [[ -f "/usr/share/wizado/scripts/lib/license-tui.sh" ]]; then
  source "/usr/share/wizado/scripts/lib/license-tui.sh"
fi

# Auto-detect available terminal emulator
detect_terminal() {
  local terminals=("kitty" "alacritty" "foot" "konsole" "gnome-terminal" "xterm")
  for term in "${terminals[@]}"; do
    if command -v "$term" >/dev/null 2>&1; then
      echo "$term"
      return 0
    fi
  done
  echo ""
  return 1
}

# Get terminal command with appropriate flags for running a command
get_terminal_cmd() {
  local term="$1"
  local cmd="$2"
  
  case "$term" in
    kitty)
      echo "kitty --class wizado-tui -e $cmd"
      ;;
    alacritty)
      echo "alacritty --class wizado-tui -e $cmd"
      ;;
    foot)
      echo "foot --app-id wizado-tui $cmd"
      ;;
    konsole)
      echo "konsole -e $cmd"
      ;;
    gnome-terminal)
      echo "gnome-terminal -- $cmd"
      ;;
    xterm)
      echo "xterm -e $cmd"
      ;;
    *)
      echo ""
      ;;
  esac
}

# Show license required notification
show_license_notification() {
  if command -v notify-send >/dev/null 2>&1; then
    notify-send -i dialog-warning "Wizado" "License required. Opening settings..." 2>/dev/null || true
  fi
}

# Run the license TUI in a terminal
run_license_tui() {
  local terminal
  terminal=$(detect_terminal)
  
  if [[ -z "$terminal" ]]; then
    echo "Error: No supported terminal emulator found" >&2
    echo "Please install one of: kitty, alacritty, foot, konsole, gnome-terminal, xterm" >&2
    exit 1
  fi
  
  # Create a temporary script for the license flow
  local tui_script
  tui_script=$(mktemp /tmp/wizado-license-tui.XXXXXX.sh)
  chmod +x "$tui_script"
  
  cat > "$tui_script" << 'TUISCRIPT'
#!/usr/bin/env bash
set -euo pipefail

# Source license functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
for lib_path in \
    "${SCRIPT_DIR}/../lib" \
    "/usr/share/wizado/scripts/lib" \
    "${HOME}/.local/share/wizado/scripts/lib"; do
  if [[ -f "${lib_path}/license.sh" ]]; then
    source "${lib_path}/license.sh"
    source "${lib_path}/license-tui.sh"
    break
  fi
done

# Main license entry flow
main() {
  while true; do
    local license_key
    license_key=$(run_license_prompt "${LICENSE_STATUS:-no_license}")
    local prompt_result=$?
    
    case $prompt_result in
      0)
        # User entered a license key
        if [[ -n "$license_key" ]]; then
          show_verifying
          if activate_license "$license_key"; then
            show_activation_success "$ACTIVATION_EMAIL" "$SLOTS_USED" "$SLOTS_TOTAL"
            # License activated, now launch wizado
            exec wizado
          else
            show_activation_failure "$ACTIVATION_MESSAGE"
            sleep 2
          fi
        fi
        ;;
      1)
        # User wants to purchase - show URL and continue loop
        sleep 2
        ;;
      2)
        # User cancelled
        exit 0
        ;;
    esac
  done
}

main
TUISCRIPT

  # Launch the TUI in the detected terminal
  show_license_notification
  
  case "$terminal" in
    kitty)
      exec kitty --class wizado-tui -e bash "$tui_script"
      ;;
    alacritty)
      exec alacritty --class wizado-tui -e bash "$tui_script"
      ;;
    foot)
      exec foot --app-id wizado-tui bash "$tui_script"
      ;;
    konsole)
      exec konsole -e bash "$tui_script"
      ;;
    gnome-terminal)
      exec gnome-terminal -- bash "$tui_script"
      ;;
    xterm)
      exec xterm -e bash "$tui_script"
      ;;
  esac
}

# Main entry point
main() {
  # Check license status
  check_license
  local license_result=$?
  
  case $license_result in
    0)
      # License valid - launch wizado
      exec wizado
      ;;
    1|2)
      # No license or needs activation - show TUI
      run_license_tui
      ;;
  esac
}

main "$@"

