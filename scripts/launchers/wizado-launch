#!/usr/bin/env bash
set -euo pipefail

# wizado-launch: License-gated launcher for wizado
# Used by waybar and keybindings to launch Steam gaming mode

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Source license functions (user local takes precedence over system)
LICENSE_LIB=""
for lib_path in \
    "${HOME}/.local/share/wizado/scripts/lib" \
    "${LIB_DIR}" \
    "/usr/share/wizado/scripts/lib"; do
  if [[ -f "${lib_path}/license.sh" ]]; then
    LICENSE_LIB="${lib_path}"
    break
  fi
done

if [[ -z "$LICENSE_LIB" ]]; then
  echo "Error: Cannot find license.sh" >&2
  exit 1
fi

source "${LICENSE_LIB}/license.sh"
[[ -f "${LICENSE_LIB}/license-tui.sh" ]] && source "${LICENSE_LIB}/license-tui.sh"

# Target workspace for wizado
WIZADO_WORKSPACE="${WIZADO_WORKSPACE:-10}"

# Auto-detect available terminal emulator
detect_terminal() {
  local terminals=("kitty" "alacritty" "foot" "konsole" "gnome-terminal" "xterm")
  for term in "${terminals[@]}"; do
    if command -v "$term" >/dev/null 2>&1; then
      echo "$term"
      return 0
    fi
  done
  echo ""
  return 1
}

# Show license required notification
show_license_notification() {
  if command -v notify-send >/dev/null 2>&1; then
    notify-send -i dialog-warning "Wizado" "License required. Opening settings..." 2>/dev/null || true
  fi
}

# Switch to workspace 10
switch_to_workspace() {
  if command -v hyprctl >/dev/null 2>&1; then
    hyprctl dispatch workspace "$WIZADO_WORKSPACE" >/dev/null 2>&1 || true
  fi
}

# Run the license TUI in a terminal
run_license_tui() {
  local terminal
  terminal=$(detect_terminal)
  
  if [[ -z "$terminal" ]]; then
    echo "Error: No supported terminal emulator found" >&2
    echo "Please install one of: kitty, alacritty, foot, konsole, gnome-terminal, xterm" >&2
    exit 1
  fi
  
  # Switch to workspace 10 first
  switch_to_workspace
  
  show_license_notification
  
  # Launch terminal with wizado-config which has the license TUI built in
  # Using wizado-config directly is more reliable than a temp script
  case "$terminal" in
    kitty)
      exec kitty --class wizado-tui --title "Wizado License" -e "${HOME}/.local/bin/wizado-config"
      ;;
    alacritty)
      exec alacritty --class wizado-tui --title "Wizado License" -e "${HOME}/.local/bin/wizado-config"
      ;;
    foot)
      exec foot --app-id wizado-tui --title "Wizado License" "${HOME}/.local/bin/wizado-config"
      ;;
    konsole)
      exec konsole --title "Wizado License" -e "${HOME}/.local/bin/wizado-config"
      ;;
    gnome-terminal)
      exec gnome-terminal --title "Wizado License" -- "${HOME}/.local/bin/wizado-config"
      ;;
    xterm)
      exec xterm -title "Wizado License" -e "${HOME}/.local/bin/wizado-config"
      ;;
  esac
}

# Main entry point
main() {
  # Check license status (|| true to prevent set -e from exiting)
  check_license || true
  
  # If check_license succeeded (valid license), launch wizado
  if [[ "$LICENSE_STATUS" == "valid" || "$LICENSE_STATUS" == "offline_grace" ]]; then
    exec wizado
  else
    # No license or needs activation - show TUI
    run_license_tui
  fi
}

main "$@"
