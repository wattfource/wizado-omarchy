#!/usr/bin/env python3
import curses
import os
import subprocess
import sys
import json

CONFIG_FILE = os.path.expanduser("~/.gaming-mode.conf")

def load_config():
    config = {}
    if os.path.exists(CONFIG_FILE):
        with open(CONFIG_FILE, 'r') as f:
            for line in f:
                if '=' in line:
                    key, val = line.strip().split('=', 1)
                    config[key] = val.strip('"').strip("'")
    return config

def save_config(config):
    lines = []
    if os.path.exists(CONFIG_FILE):
        with open(CONFIG_FILE, 'r') as f:
            lines = f.readlines()
    
    # Update existing keys
    new_lines = []
    seen_keys = set()
    for line in lines:
        if '=' in line:
            key = line.split('=', 1)[0].strip()
            if key in config:
                new_lines.append(f'{key}="{config[key]}"\n')
                seen_keys.add(key)
                continue
        new_lines.append(line)
    
    # Add new keys
    for key, val in config.items():
        if key not in seen_keys:
            new_lines.append(f'{key}="{val}"\n')
            
    with open(CONFIG_FILE, 'w') as f:
        f.writelines(new_lines)

def get_display_info():
    try:
        # Try to use hyprctl to get current monitor info
        output = subprocess.check_output(["hyprctl", "monitors", "-j"], stderr=subprocess.DEVNULL)
        data = json.loads(output)
        if data:
            # Get the focused monitor or the first one
            monitor = next((m for m in data if m.get("focused")), data[0])
            return monitor["width"], monitor["height"], monitor["refreshRate"]
    except Exception:
        pass
    return 1920, 1080, 60

def draw_menu(stdscr, title, options, current_selection):
    stdscr.clear()
    h, w = stdscr.getmaxyx()
    
    # Draw title box
    box_w = 60
    box_h = len(options) + 6
    start_y = (h - box_h) // 2
    start_x = (w - box_w) // 2
    
    # Draw border
    # win = curses.newwin(box_h, box_w, start_y, start_x)
    # win.box()
    
    # Draw title
    title_str = f" {title} "
    stdscr.addstr(start_y + 1, start_x + (box_w - len(title_str)) // 2, title_str, curses.A_BOLD)
    
    # Draw separator
    stdscr.hline(start_y + 3, start_x + 2, curses.ACS_HLINE, box_w - 4)

    # Draw options
    for idx, (label, desc) in enumerate(options):
        x = start_x + 4
        y = start_y + 5 + idx
        if idx == current_selection:
            stdscr.attron(curses.A_REVERSE)
            stdscr.addstr(y, x, f"> {label:<20} | {desc}")
            stdscr.attroff(curses.A_REVERSE)
        else:
            stdscr.addstr(y, x, f"  {label:<20} | {desc}")
            
    # Draw footer
    footer = "↑↓ navigate • enter submit"
    stdscr.addstr(start_y + box_h - 2, start_x + 4, footer, curses.A_DIM)
    
    stdscr.refresh()

def resolution_menu(stdscr):
    dw, dh, dr = get_display_info()
    
    # Define resolution options based on current display
    # Logic: Always offer Native, 1080p, 720p. If 4K, offer 1440p.
    
    options = []
    
    # Native / Auto
    options.append(("Auto / Native", f"Use detected resolution ({dw}x{dh})"))

    # Upscaling presets based on native res
    if dw == 3840 and dh == 2160:
        options.append(("UHD Upscaled", "Render at 1440p, upscale to 4K (balanced)"))
        options.append(("1440p Upscaled", "Render at 1080p, upscale to 1440p (better FPS)")) 
    elif dw == 2560 and dh == 1440:
        options.append(("1440p Upscaled", "Render at 1080p, upscale to 1440p (better FPS)"))
    
    # Standard options if not already covered
    if (dw, dh) != (2560, 1440):
         options.append(("1440p (2560x1440)", "Render at 1440p resolution"))
         
    if (dw, dh) != (1920, 1080):
        options.append(("1080p (1920x1080)", "Render at 1080p resolution"))
        
    if (dw, dh) != (1280, 720):
        options.append(("720p (1280x720)", "Render at 720p resolution"))
        
    options.append(("Back", "Return to main menu"))
    
    selection = 0
    
    while True:
        draw_menu(stdscr, f"Gaming Mode - Resolution Settings (Display: {dw}x{dh})", options, selection)
        key = stdscr.getch()
        
        if key == curses.KEY_UP:
            selection = (selection - 1) % len(options)
        elif key == curses.KEY_DOWN:
            selection = (selection + 1) % len(options)
        elif key == 10: # Enter
            choice = options[selection][0]
            if choice == "Back":
                return
            
            config = load_config()
            
            if choice == "Auto / Native":
                # Clear resolution settings to let enter-gamesmode auto-detect
                if "GAMESMODE_INTERNAL_W" in config: del config["GAMESMODE_INTERNAL_W"]
                if "GAMESMODE_INTERNAL_H" in config: del config["GAMESMODE_INTERNAL_H"]
                save_config(config)
                return

            # Parse choice
            w, h = 0, 0
            if choice == "UHD Upscaled":
                w, h = 2560, 1440
            elif choice == "1440p Upscaled":
                w, h = 1920, 1080
            elif "x" in choice and not "Upscaled" in choice:
                # Extract resolution from string like "3840x2160" or "1080p (1920x1080)"
                import re
                m = re.search(r'(\d+)x(\d+)', choice)
                if m:
                    w, h = int(m.group(1)), int(m.group(2))
            
            if w and h:
                # config already loaded above
                config["GAMESMODE_INTERNAL_W"] = str(w)
                config["GAMESMODE_INTERNAL_H"] = str(h)
                save_config(config)
                return

def main_menu(stdscr):
    curses.curs_set(0)
    curses.start_color()
    # curses.init_pair(1, curses.COLOR_CYAN, curses.COLOR_BLACK)
    
    options = [
        ("Launch", "Start Gaming Mode"),
        ("Settings", "Configure Resolution & Options"),
        ("Exit", "Exit Menu")
    ]
    selection = 0
    
    while True:
        draw_menu(stdscr, "Wizado Gaming Mode", options, selection)
        key = stdscr.getch()
        
        if key == curses.KEY_UP:
            selection = (selection - 1) % len(options)
        elif key == curses.KEY_DOWN:
            selection = (selection + 1) % len(options)
        elif key == 10: # Enter
            if selection == 0: # Launch
                curses.endwin()
                script_dir = os.path.dirname(os.path.abspath(__file__))
                launcher = os.path.join(script_dir, "enter-gamesmode")
                subprocess.run([launcher, "--mode", "nested"])
                sys.exit(0)
            elif selection == 1: # Settings
                resolution_menu(stdscr)
            elif selection == 2: # Exit
                return

if __name__ == "__main__":
    try:
        curses.wrapper(main_menu)
    except KeyboardInterrupt:
        pass

