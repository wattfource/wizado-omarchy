#!/usr/bin/env bash
set -euo pipefail

# wizado-waybar: Waybar module helper script
# Returns JSON for the custom waybar module

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Source license functions (user local takes precedence over system)
for lib_path in \
    "${HOME}/.local/share/wizado/scripts/lib" \
    "${LIB_DIR}" \
    "/usr/share/wizado/scripts/lib"; do
  if [[ -f "${lib_path}/license.sh" ]]; then
    source "${lib_path}/license.sh"
    break
  fi
done

# Check license and output JSON for waybar
main() {
  local icon=""  # nf-fa-hat_wizard
  local tooltip="Wizado Gaming Mode"
  local class="inactive"
  local alt="unlicensed"
  
  # Check license status (suppress errors for waybar stability)
  if check_license 2>/dev/null; then
    class="licensed"
    alt="licensed"
    tooltip="Wizado Gaming Mode\n━━━━━━━━━━━━━━━━━━━\nLeft-click: Launch Steam\nRight-click: Settings"
  else
    class="unlicensed"
    alt="unlicensed"
    tooltip="Wizado Gaming Mode\n━━━━━━━━━━━━━━━━━━━\nLicense Required\n\$5 for 5 machines\nwizado.app\n━━━━━━━━━━━━━━━━━━━\nLeft-click: Enter License\nRight-click: Settings"
  fi
  
  # Output JSON for waybar
  printf '{"text": "%s", "tooltip": "%s", "class": "%s", "alt": "%s"}\n' \
    "$icon" "$tooltip" "$class" "$alt"
}

main "$@"

